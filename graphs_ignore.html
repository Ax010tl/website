<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphs</title>
    <style>
        html, body{
            font-family: 'Raleway', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        aside{
            font-family: 'Raleway', sans-serif;
            width: 300px;
            padding: 20px;
            flex-shrink: 1;
            box-sizing: border-box;
            position:sticky; 
            overflow-y: auto;
            background-color: rgba(31,9,71,0.4);
        }
        aside a{
            display: block;
            margin: 0.8em 0;
            text-decoration: none; 
            color: black; 
            font-weight: 550;
        }
        aside a:hover{
            text-decoration: underline;
        }
        main{
            flex: 1;
            overflow-y: auto;
        }

        .graph-cont{
            padding: 16px;
            box-sizing: border-box; 

        }
        .graph-cont canvas{
            width: 100% !important;
            max-height: 60vh !important;
        }

        #title{
            display:flex; 
            flex-direction: column;
            justify-content: center;
            align-content: center;
            text-align: center;
        }

        #banner{
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }

        @media screen and (max-width: 600px) {
            aside{
                display:none; 
            }
        }

    </style>
</head>
<body>
    <aside>
        <h2>Tabla de contenidos</h2>
    </aside>
    <main> 
        <div id="title">
            <h1>Indicadores</h1>
            <img id="banner" src="../static/graphs/indicadores_banner.png">
        </div>
        <section class="graph-cont"id="subjectinterest">
            <h2>üìö Inter√©s por area STEM</h2>
            <canvas id="subjectinterest-grafica"></canvas>
        </section>
    
        <section class="graph-cont"id="schoolLevel_subject">
            <h2> üè´ Nivel de escolaridad por inter√©s en √°rea de STEM</h2>
            <canvas id="schoolLevel_subject-grafica"></canvas>
        </section>

        <section class="graph-cont" id="gender_view">
            <h2> ‚öñÔ∏è Distribuci√≥n de g√©neros</h2>
            <canvas id="gender_view-grafica"></canvas>
        </section>
        
        <section class="graph-cont" id="schoolLevel_view">
            <h2>üéì Nivel de escolaridad</h2>
            <canvas id="schoolLevel_view-grafica"></canvas>
        </section>

        <section class="graph-cont" id="ages_view">
            <h2>üßÆ Distribuci√≥n de edades</h2>
            <!-- segmentando cada 5 a√±os -->
        </section>

        <section class="graph-cont" id="gender_subject">
            <h2>‚öôÔ∏è Inter√©s en √°rea de STEM por g√©nero</h2>
            <canvas id="gender_subject-grafica"></canvas>

        </section>
    </main>
    

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function getTableOfContents(){
            let elements = document.querySelectorAll('.graph-cont');
            elements.forEach(element=>{
                let link = document.createElement('a');
                link.href = '#'+element.id;
                link.innerHTML = element.querySelector('h2').innerText;
                document.querySelector('aside').append(link)
            })
        }
        getTableOfContents();

        async function obtenerSubjectInterest(){
            const req = await fetch('/views/subjectinterest');
            const data = await req.json();
            const config = {
                type: 'bar',
                data: {
                    datasets: [{
                        label: '',
                        data: data,
                        backgroundColor: [
                            'rgba(27, 193, 161, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 96, 87, 0.7)'
                        ],
                    }]
                },
                options: {
                    parsing: {
                        xAxisKey: '√Årea STEM',
                        yAxisKey: 'Inter√©s'
                    },
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false
                        }
                    }
                },
            };
            const chart = new Chart(document.getElementById('subjectinterest-grafica'), config)
        }

        async function obtenerSchoolLevel_subject(){
            let materias = ['Biolog√≠a', 'Qu√≠mica', 'F√≠sica', 'Ingenier√≠a', 'Tecnolog√≠a', 'Matem√°ticas']
            let grados = ['Actualmente no estudio','Preescolar', 'Primaria', 'Secundaria', 'Preparatoria', 'Otro'];
            const req = await fetch('/views/schoolLevel_subject');
            const data = await req.json();
            // Ordenar datos por grado
            const data_ordenada = data.sort((a, b)=>{
                return grados.indexOf(a.schoolLevel) - grados.indexOf(b.schoolLevel) 
            });
            const data_arreglado = [
                {label: "Biolog√≠a", data: [], borderColor:['rgba(27, 193, 161, 0.3)'], backgroundColor: ['rgba(27, 193, 161, 0.5)']},
                {label: "Qu√≠mica", data: [], borderColor:['rgba(255, 206, 86, 0.3)'], backgroundColor: ['rgba(255, 206, 86, 0.5)']},
                {label: "F√≠sica", data: [], borderColor:['rgba(255, 159, 64, 0.3)'], backgroundColor: ['rgba(255, 159, 64, 0.5)']},
                {label: "Ingenier√≠a", data: [], borderColor:['rgba(54, 162, 235, 0.3)'], backgroundColor: ['rgba(54, 162, 235, 0.5)']},
                {label: "Tecnolog√≠a", data: [], borderColor:['rgba(153, 102, 255, 0.3)'], backgroundColor: ['rgba(153, 102, 255, 0.5)']},
                {label: "Matem√°ticas", data: [], borderColor:['rgba(255, 96, 87, 0.3)'], backgroundColor: ['rgba(255, 96, 87, 0.5)']},
            ]; 
            for(let data_row of data_ordenada){
                let schoolLevel = data_row.schoolLevel;
                for(let materia of materias){
                    // Encontar materia en data_arreglado
                    let m = data_arreglado.find(i=>i.label==materia);
                    // Agregarle el school level con el valor de la materia
                    m.data.push({x: schoolLevel, y: data_row[materia]})
                }
            }
            const config = {
                type: 'line',
                data: {datasets: data_arreglado}
            }
            const chart = new Chart(document.getElementById('schoolLevel_subject-grafica'), config)
        }

        async function obtenerGender_view(){
            const req = await fetch('/views/gender_view');
            const data = await req.json();
            const config = {
                type: 'doughnut',
                data: {
                    labels: data.map(gender=>gender.gender),
                    datasets: [{
                        data: data.map(gender=>gender['count(gender)']),
                        backgroundColor: ['rgba(27, 193, 161, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 159, 64, 0.7)'],
                        hoverOffset: 4
                    }]
                }


            }
            const chart = new Chart(document.getElementById('gender_view-grafica'), config)
        }

        async function obtenerSchoolLevel_view(){
            const req = await fetch('/views/schoolLevel_view');
            const data = await req.json();
            const config = {
                type: 'doughnut',
                data: {
                    labels: data.map(schoolLevel=>schoolLevel.schoolLevel),
                    datasets: [{
                        data: data.map(schoolLevel=>schoolLevel['count(schoolLevel)']),
                        backgroundColor: [
                            'rgba(27, 193, 161, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 96, 87, 0.7)'
                        ],
                        hoverOffset: 4
                    }]
                }
                
                
            }
            const chart = new Chart(document.getElementById('schoolLevel_view-grafica'), config)
        }
        
        async function obtenerAges_view(){
            const req = await fetch('/views/ages_view');
            const data = await req.json();
            const chart = new Chart(document.getElementById('ages_view-grafica'), config)
        }
        async function obtenerGender_subject(){
            let materias = ['Biolog√≠a', 'Qu√≠mica', 'F√≠sica', 'Ingenier√≠a', 'Tecnolog√≠a', 'Matem√°ticas']
            const req = await fetch('/views/gender_subject');
            const data = await req.json();
            const backgroundColor = ['rgba(27, 193, 161, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 159, 64, 0.7)']
            const data_corregida = data.map((row, i)=>{
                let obj = {};
                obj.label = row['G√©nero'];
                obj.data = Object.keys(row).filter(key=>key!='G√©nero').map(key=>({ x: key, y: row[key] }))
                obj.backgroundColor = backgroundColor[i];
                return obj;
            })
            console.log(data_corregida)

            const config = {
                type: 'bar',
                data: {
                    datasets: data_corregida
                }, 
                options: {
                    scales: {
                        x: {stacked: true}, 
                        y: {stacked: true}
                    }
                }
            }
            const chart = new Chart(document.getElementById('gender_subject-grafica'), config)
        }


        obtenerSubjectInterest();
        obtenerSchoolLevel_subject();
        obtenerGender_view();
        obtenerSchoolLevel_view();
        //obtenerAges_view();
        obtenerGender_subject();
    </script>

</body>
</html>